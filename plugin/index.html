<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AutoPlan Settings</title><style>*{box-sizing:border-box;}body{font-family:'Open Sans',sans-serif;margin:0;padding:20px;color:var(--text-color);}h1{font-size:14px;margin:0 0 4px 0;}.subtitle{font-size:14px;opacity:0.7;margin-bottom:20px;}.section{margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--separator-color);}.section:last-of-type{border-bottom:none;}.section-title{font-weight:600;margin-bottom:12px;}.form-group{margin-bottom:12px;}label{display:block;font-size:0.9em;opacity:0.7;margin-bottom:4px;}input[type="number"],input[type="text"],select{width:100%;padding:8px;font-size:inherit;font-family:inherit;border:1px solid var(--separator-color);border-radius:4px;background:transparent;color:var(--text-color);}input[type="checkbox"]{width:16px;height:16px;}.checkbox-group{display:flex;align-items:center;gap:8px;}.checkbox-group label{margin-bottom:0;opacity:1;}.row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}.help-text{font-size:0.8em;opacity:0.6;margin-top:4px;}.section-description{font-size:0.9em;opacity:0.7;margin-bottom:12px;}.intro-section{margin-bottom:20px;}.how-it-works{margin-bottom:12px;}.how-it-works summary{cursor:pointer;font-weight:500;opacity:0.8;padding:8px 0;user-select:none;}.how-it-works summary:hover{opacity:1;}.how-it-works:not([open]) summary{color:#888 !important;font-weight:normal;}.how-it-works[open] summary{font-weight:500;}.intro-content{padding:12px;background:rgba(128,128,128,0.1);border-radius:4px;margin-top:8px;}.intro-content ol{padding-left:20px;margin:12px 0;}.intro-content li{margin-bottom:8px;}.tip-box{padding:12px;background:rgba(124,77,255,0.1);border-left:3px solid var(--c-primary,#7c4dff);border-radius:4px;margin-bottom:16px;}.tip-box p{margin:8px 0 0 0;font-size:0.9em;opacity:0.85;}.tip-box strong{display:block;margin-bottom:4px;}.tag-table{width:100%;border-collapse:collapse;}.tag-table th,.tag-table td{padding:8px;text-align:left;border-bottom:1px solid var(--separator-color);}.tag-table th{font-weight:600;font-size:0.8em;text-transform:uppercase;opacity:0.7;}.tag-table input{width:80px;}.tag-badge{display:inline-block;padding:2px 8px;border:1px solid var(--separator-color);border-radius:12px;font-size:0.85em;}.add-tag-row{display:flex;gap:8px;margin-top:12px;}.add-tag-row input{flex:1;}.btn{padding:8px 16px;border:1px solid var(--separator-color);border-radius:4px;font-size:inherit;font-family:inherit;cursor:pointer;background:transparent;color:var(--text-color);}.btn:hover{opacity:0.8;}.btn-primary{background:var(--c-primary,#7c4dff);border:2px solid var(--c-primary,#7c4dff);color:var(--c-primary-contrast,#ffffff);}.btn-primary:hover{opacity:0.9;box-shadow:0 2px 8px rgba(0,0,0,0.2);}.btn-small{padding:4px 10px;font-size:0.85em;}.actions{display:flex;gap:12px;margin-top:20px;}.schedule-preview{max-height:500px;overflow-y:auto;}.schedule-day{margin-bottom:16px;}.schedule-day-header{font-weight:600;padding:8px 0;border-bottom:2px solid var(--c-primary,#7c4dff);margin-bottom:8px;position:sticky;top:0;background:var(--background-color,#fff);}.schedule-item{display:flex;align-items:center;padding:8px 0;border-bottom:1px solid var(--separator-color);}.schedule-item:last-child{border-bottom:none;}.schedule-time{font-size:0.85em;font-weight:500;min-width:110px;color:var(--c-primary,#7c4dff);}.schedule-title{flex:1;margin-right:16px;margin-left:16px;}.schedule-urgency{font-size:0.85em;padding:2px 8px;border:1px solid var(--separator-color);border-radius:10px;white-space:nowrap;}.schedule-summary{padding:12px;background:rgba(var(--c-primary-rgb,124,77,255),0.1);border-radius:8px;margin-bottom:16px;}.schedule-summary-row{display:flex;justify-content:space-between;padding:4px 0;}.status{padding:10px;border:1px solid var(--separator-color);border-radius:4px;margin-bottom:16px;display:none;align-items:center;justify-content:space-between;}.status.show{display:flex;}.status-close{background:none;border:none;font-size:20px;cursor:pointer;opacity:0.7;padding:0 4px;margin-left:12px;color:inherit;}.status-close:hover{opacity:1;}.status.warning{background:rgba(255,152,0,0.1);border-color:#ff9800;}.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;}.modal-overlay.show{display:flex;}.modal{background:var(--background-color,#fff);border-radius:8px;padding:24px;max-width:400px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3);}.modal-title{font-weight:600;font-size:1.1em;margin-bottom:16px;}.modal-body{margin-bottom:20px;line-height:1.5;}.modal-body ul{margin:12px 0;padding-left:20px;}.modal-body li{margin-bottom:4px;}.modal-actions{display:flex;gap:12px;justify-content:flex-end;}.btn-danger{background:#dc3545;border-color:#dc3545;color:#fff;opacity:0.7;}.btn-danger:hover{opacity:1;background:#c82333;border-color:#bd2130;}.loading{text-align:center;padding:40px;opacity:0.7;}.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--separator-color);border-top-color:var(--c-primary);border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;vertical-align:middle;}@keyframes spin{to{transform:rotate(360deg);}}.tabs{display:flex;border-bottom:1px solid var(--separator-color);margin-bottom:16px;flex-wrap:wrap;}.tab{padding:10px 16px;cursor:pointer;opacity:0.6;border-bottom:2px solid transparent;}.tab:hover{opacity:0.9;}.tab.active{opacity:1;border-bottom-color:var(--c-primary);}.tab-content{display:none;}.tab-content.active,div.tab-content.active,#tab-merge.active,#tab-priorities.active,#tab-tags-priorities.active,#tab-time-maps.active,#tab-formulas.active,#tab-other-settings.active{display:block;}.formula-preview{padding:10px;border:1px solid var(--separator-color);border-radius:4px;font-family:monospace;font-size:0.9em;margin-top:8px;opacity:0.8;}.run-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--separator-color,#e0e0e0);}.btn-spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--c-primary-contrast);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;}.priority-item{padding:10px 0;border-bottom:1px solid var(--separator-color);}.priority-item:last-child{border-bottom:none;}.priority-header{display:flex;align-items:center;justify-content:space-between;gap:12px;}.priority-title{flex:1;font-weight:500;}.priority-score{font-size:0.9em;font-weight:600;padding:4px 10px;background:var(--c-primary,#7c4dff);color:var(--c-primary-contrast,#ffffff);border-radius:12px;white-space:nowrap;}.priority-explanation{font-size:0.8em;opacity:0.5;margin-top:4px;font-family:monospace;}.time-map-card{border:1px solid var(--separator-color);border-radius:8px;padding:12px;margin-bottom:12px;}.time-map-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}.time-map-name{font-weight:600;font-size:1em;}.time-map-actions{display:flex;gap:8px;}.time-map-schedule{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;font-size:0.75em;}.time-map-day{text-align:center;padding:4px;border-radius:4px;background:rgba(128,128,128,0.1);}.time-map-day.skip{opacity:0.4;}.time-map-day-name{font-weight:600;margin-bottom:2px;}.time-map-day-hours{opacity:0.7;}.day-editor-row{display:grid;grid-template-columns:80px 1fr;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--separator-color);}.day-editor-row:last-child{border-bottom:none;}.day-editor-name{font-weight:500;}.day-editor-inputs{display:flex;align-items:center;gap:8px;}.day-editor-inputs input[type="number"]{width:60px;}.day-editor-inputs .checkbox-group{margin-left:auto;}.compact-only{display:none;}.full-only{display:block;}body.compact-mode .compact-only{display:block;}body.compact-mode .full-only{display:none;}body.compact-mode .tabs,body.compact-mode .tab-content{display:none !important;}body.compact-mode .run-section{margin-bottom:0;}.open-settings-btn{width:100%;margin-top:16px;padding:12px;font-size:1em;}</style></head><body><h1>AutoPlan</h1><p class="subtitle">Automatic task scheduling based on priority and urgency</p><div id="status" class="status"></div><div class="run-section"><div style="display: flex; gap: 12px; margin-bottom: 16px;"><button class="btn btn-primary" style="flex: 1;" onclick="handleDryRun()">üîç Dry Run</button><button class="btn btn-primary" style="flex: 1;" id="applyButton" onclick="handleApplySchedule()"><span id="applyButtonContent">‚ö° Apply Schedule</span></button></div></div><div class="section"><div class="section-title">Clear Planning</div><button class="btn btn-danger" onclick="showClearPlanningModal()">Clear All Planning</button></div><div class="tabs"><div class="tab active" data-tab="priorities">Task Priorities</div><div class="tab" data-tab="tags-priorities">Tags and Projects Settings</div><div class="tab" data-tab="time-maps">Time Maps</div><div class="tab" data-tab="formulas">Priority formulas</div><div class="tab" data-tab="other-settings">Other settings</div><div class="tab" data-tab="merge">Manage Split Tasks</div></div><div id="tab-priorities" class="tab-content active"><div class="section"><div class="section-title">Task Priorities</div><p class="section-description">Tasks sorted by their computed priority score. Higher priority tasks are scheduled first.</p><button class="btn" onclick="loadTaskPriorities()">Refresh Priorities</button><div id="prioritiesList" style="margin-top: 16px;"><div class="loading"><div class="spinner"></div>Loading task priorities...</div></div></div><div class="section" id="schedulePreviewSection" style="display: none;"><div class="section-title">Schedule Preview</div><p class="section-description">Preview of what tasks would be scheduled and when. Click "Dry Run" to generate this preview.</p><div id="schedulePreview"></div></div></div><div id="tab-tags-priorities" class="tab-content"><details class="how-it-works"><summary style="color: #888;">Show Help</summary><div class="intro-content"><p><strong>How Tags and Project Priorities Work</strong></p><p>When a task has a tag or belongs to a project listed here, that boost value is added to its total priority score. Tasks with higher priority get scheduled earlier.</p><p><strong>Examples:</strong></p><ul><li>Add +20 to "Urgent" tag to schedule urgent tasks sooner</li><li>Add -10 to "Low Priority" to push those tasks later</li><li>Add +15 to "Work" project to prioritize work tasks</li></ul></div></details><div class="section"><div class="section-title">Tag Priority Boosts</div><p class="section-description">Give certain types of tasks higher or lower priority based on their tags.</p><table class="tag-table" id="tagTable"><thead><tr><th>Tag Name</th><th>Priority Boost</th><th></th></tr></thead><tbody id="tagTableBody"></tbody></table><div class="add-tag-row"><select id="newTagName"><option value="">Select a tag...</option></select><input type="number" id="newTagPriority" placeholder="Boost" value="10" style="width: 80px;"><button class="btn btn-small" onclick="addTagPriority()">Add Tag</button></div><p class="help-text">Select a tag from the dropdown to add a priority boost.</p></div><div class="section"><div class="section-title">Project Priority Boosts</div><p class="section-description">Give tasks in certain projects higher or lower priority.</p><table class="tag-table" id="projectTable"><thead><tr><th>Project Name</th><th>Priority Boost</th><th></th></tr></thead><tbody id="projectTableBody"></tbody></table><div class="add-tag-row"><select id="newProjectName"><option value="">Select a project...</option></select><input type="number" id="newProjectPriority" placeholder="Boost" value="10" style="width: 80px;"><button class="btn btn-small" onclick="addProjectPriority()">Add Project</button></div><p class="help-text">Select a project from the dropdown to add a priority boost.</p></div><div class="actions"><button class="btn" onclick="saveSettings()">Save Settings</button><button class="btn" onclick="resetToDefaults()">Reset to Defaults</button></div></div><div id="tab-time-maps" class="tab-content"><details class="how-it-works"><summary style="color: #888;">Show Help</summary><div class="intro-content"><p><strong>How Time Maps Work</strong></p><p>Time maps define when tasks can be scheduled. Each time map has per-day settings for start/end hours, or can skip days entirely.</p><p><strong>Examples:</strong></p><ul><li><strong>Default:</strong> Work hours Mon-Fri 9am-5pm, weekends off</li><li><strong>Evenings:</strong> Personal tasks scheduled 7pm-10pm on weekdays</li><li><strong>Weekends Only:</strong> Side projects scheduled Sat-Sun 10am-4pm</li></ul><p>You can assign different projects to different time maps, so work tasks and personal tasks don't overlap.</p></div></details><div class="section"><div class="section-title">Time Maps</div><p class="section-description">Define different scheduling windows. Each time map specifies available hours for each day of the week.</p><div id="timeMapsContainer"></div><button class="btn" onclick="showAddTimeMapModal()" style="margin-top: 12px;">+ Add Time Map</button></div><div class="section"><div class="section-title">Project Time Map Assignments</div><p class="section-description">Assign projects to specific time maps. Tasks from unassigned projects use the default time map.</p><div class="form-group"><label for="defaultTimeMapSelect">Default Time Map</label><select id="defaultTimeMapSelect" onchange="updateDefaultTimeMap()"></select><p class="help-text">Used for tasks from projects without a specific assignment.</p></div><table class="tag-table" id="projectTimeMapTable"><thead><tr><th>Project</th><th>Time Map</th><th></th></tr></thead><tbody id="projectTimeMapTableBody"></tbody></table><div class="add-tag-row"><select id="newProjectTimeMapProject"><option value="">Select a project...</option></select><select id="newProjectTimeMapTimeMap"><option value="">Select a time map...</option></select><button class="btn btn-small" onclick="addProjectTimeMapAssignment()">Assign</button></div></div><div class="section"><div class="section-title">Tag Time Map Assignments</div><p class="section-description">Assign tags to specific time maps. Tasks with these tags will be scheduled in the corresponding time map.A task can belong to multiple time maps if it has multiple mapped tags.</p><table class="tag-table" id="tagTimeMapTable"><thead><tr><th>Tag</th><th>Time Map</th><th></th></tr></thead><tbody id="tagTimeMapTableBody"></tbody></table><div class="add-tag-row"><select id="newTagTimeMapTag"><option value="">Select a tag...</option></select><select id="newTagTimeMapTimeMap"><option value="">Select a time map...</option></select><button class="btn btn-small" onclick="addTagTimeMapAssignment()">Assign</button></div></div><div class="actions"><button class="btn" onclick="saveSettings()">Save Settings</button><button class="btn" onclick="resetToDefaults()">Reset to Defaults</button></div></div><div id="tab-formulas" class="tab-content"><details class="how-it-works"><summary style="color: #888;">Show Help</summary><div class="intro-content"><p><strong>Understanding Priority Formulas</strong></p><p>These formulas add bonus priority based on task characteristics. The weight controls how much influence each factor has on the final priority score.</p><p><strong>Duration Priority:</strong> Should shorter or longer tasks be prioritized?</p><p><strong>Oldness Priority:</strong> Should older tasks be prioritized to prevent them from being forgotten?</p><p><strong>Deadline Priority:</strong> Should tasks with approaching deadlines be prioritized? This uses the task's due date.</p><p><strong>Total Formula:</strong> Total Priority = Tag Boosts + Project Boosts + Duration Factor + Oldness Factor + Deadline Factor</p></div></details><div class="section"><div class="section-title">Duration Priority Formula</div><p class="section-description">Should shorter or longer tasks be prioritized?</p><div class="row"><div class="form-group"><label for="durationFormula">Formula Type</label><select id="durationFormula"><option value="none">None (duration doesn't affect priority)</option><option value="linear">Linear - longer tasks = higher priority</option><option value="inverse">Inverse - shorter tasks = higher priority</option><option value="log">Logarithmic - moderate effect, diminishing returns</option></select></div><div class="form-group"><label for="durationWeight">Weight (0-10)</label><input type="number" id="durationWeight" min="0" max="10" step="0.1" value="1.0"><p class="help-text">Higher = stronger effect. Set to 0 to disable.</p></div></div><div class="formula-preview" id="durationPreview">Duration Priority = linear(hours) * 1.0</div></div><div class="section"><div class="section-title">Oldness Priority Formula</div><p class="section-description">Should older tasks be prioritized to prevent them from being forgotten?</p><div class="row"><div class="form-group"><label for="oldnessFormula">Formula Type</label><select id="oldnessFormula"><option value="none">None (age doesn't affect priority)</option><option value="linear">Linear - priority grows steadily with age</option><option value="log">Logarithmic - quick initial boost, then levels off</option><option value="exponential">Exponential - old tasks become very urgent</option></select></div><div class="form-group"><label for="oldnessWeight">Weight (0-10)</label><input type="number" id="oldnessWeight" min="0" max="10" step="0.1" value="1.0"><p class="help-text">Higher = stronger effect. Set to 0 to disable.</p></div></div><div class="formula-preview" id="oldnessPreview">Oldness Priority = linear(days) * 1.0</div></div><div class="section"><div class="section-title">Deadline Priority Formula</div><p class="section-description">Should tasks with approaching deadlines be prioritized? Tasks with due dates will get higher priority as their deadline approaches.</p><div class="row"><div class="form-group"><label for="deadlineFormula">Formula Type</label><select id="deadlineFormula"><option value="none">None (deadlines don't affect priority)</option><option value="linear">Linear - steady increase as deadline approaches</option><option value="aggressive">Aggressive - sharp increase near deadline</option></select></div><div class="form-group"><label for="deadlineWeight">Weight (0-20)</label><input type="number" id="deadlineWeight" min="0" max="20" step="0.5" value="12.0"><p class="help-text">Higher = stronger effect. Default is 12.0.</p></div></div><div class="formula-preview" id="deadlinePreview">Deadline Priority = linear(days_until_due) * 12.0</div></div><div class="section"><div class="section-title">Total Priority Formula</div><p class="section-description">The final priority score combines all factors:</p><div class="formula-preview">Total Priority = Tag Boosts + Project Boosts + Duration Factor + Oldness Factor + Deadline Factor</div><p class="help-text" style="margin-top: 8px;">Tasks with higher total priority get scheduled first.</p></div><div class="actions"><button class="btn" onclick="saveSettings()">Save Settings</button><button class="btn" onclick="resetToDefaults()">Reset to Defaults</button></div></div><div id="tab-other-settings" class="tab-content"><details class="how-it-works"><summary style="color: #888;">Show Help</summary><div class="intro-content"><p><strong>How AutoPlan Works</strong></p><p>AutoPlan automatically schedules your tasks by splitting them into time blocks and assigning them to your calendar based on calculated urgency.</p><ol><li><strong>Priority Calculation:</strong> Each task gets a priority score based on tags, projects, duration, and age</li><li><strong>Task Splitting:</strong> Large tasks are split into manageable time blocks (e.g., 2-hour chunks)</li><li><strong>Smart Scheduling:</strong> Blocks are scheduled iteratively - the most urgent task gets the next available slot, then priorities are recalculated</li><li><strong>Calendar Integration:</strong> Scheduled blocks appear in your Super Productivity timeline</li></ol><p><strong>Requirements:</strong> Tasks must have a time estimate to be scheduled. Tasks without estimates are skipped.</p></div></details><div class="section"><div class="section-title">Block Settings</div><p class="section-description">Control how tasks are divided into schedulable time blocks.</p><div class="row"><div class="form-group"><label for="blockSize">Preferred Block Size (minutes)</label><input type="number" id="blockSize" min="15" max="480" step="15" value="120"><p class="help-text">Target duration for each scheduled block. Example: A 6-hour task becomes 3 x 2-hour blocks.</p></div><div class="form-group"><label for="minBlockSize">Minimum Block Size (minutes)</label><input type="number" id="minBlockSize" min="5" max="120" step="5" value="30"><p class="help-text">Smallest block allowed. If remaining time in a day is less than this, it's left empty.</p></div></div><div class="row"><div class="form-group"><label for="maxDays">Planning Horizon (days)</label><input type="number" id="maxDays" min="1" max="365" value="30"><p class="help-text">How far ahead to schedule tasks. Tasks won't be scheduled beyond this many days from today.</p></div><div class="form-group"><div class="checkbox-group" style="margin-top: 28px;"><input type="checkbox" id="autoRun"><label for="autoRun">Auto-run on startup</label></div><p class="help-text">Automatically reschedule all tasks when Super Productivity starts.</p></div></div></div><div class="section"><div class="section-title">Task Splitting</div><p class="section-description">Configure how split tasks are named.</p><div class="form-group"><div class="checkbox-group"><input type="checkbox" id="splitSuffix" checked><label for="splitSuffix">Add Roman numeral suffix (&lt;I&gt;, &lt;II&gt;, &lt;III&gt;...)</label></div><p class="help-text">When enabled, split tasks are named "Task Name &lt;I&gt;", "Task Name &lt;II&gt;", etc. When disabled, all splits keep the original task name.</p></div></div><div class="section"><div class="section-title">Fixed Tasks (Do Not Reschedule)</div><p class="section-description">Some tasks have fixed times (meetings, appointments) and shouldn't be moved by AutoPlan.</p><div class="form-group"><label for="doNotRescheduleTag">Do Not Reschedule Tag</label><select id="doNotRescheduleTag"><option value="">(None - reschedule all tasks)</option></select><p class="help-text">Tasks with this tag will keep their existing schedule and won't be rescheduled. Their time is subtracted from available hours on those days, so other tasks schedule around them.</p></div><div class="form-group"><div class="checkbox-group"><input type="checkbox" id="treatIcalAsFixed"><label for="treatIcalAsFixed">Treat iCal tasks as fixed</label></div><p class="help-text">When enabled, tasks imported from iCal (calendar events) will be treated as fixed and won't be rescheduled. They will be skipped in the priority list.</p></div><div class="form-group"><div class="checkbox-group"><input type="checkbox" id="excludeBacklogTasks"><label for="excludeBacklogTasks">Exclude backlog tasks</label></div><p class="help-text">When enabled, tasks in a project's backlog will not be scheduled. Backlog tasks are those that have not been completed in time.</p></div></div><div class="section"><div class="section-title">Work Schedule</div><p class="section-description">Define your available working hours. Tasks will only be scheduled during these times.</p><div class="row"><div class="form-group"><label for="workdayStartHour">Workday Start Hour (0-23)</label><input type="number" id="workdayStartHour" min="0" max="23" value="9"><p class="help-text">Hour when your workday begins (24-hour format). Example: 9 = 9:00 AM</p></div><div class="form-group"><label for="workdayHours">Workday Length (hours)</label><input type="number" id="workdayHours" min="1" max="24" value="8"><p class="help-text">How many hours you work per day. Example: 8 hours starting at 9 AM = work until 5 PM</p></div></div><div class="form-group"><label>Days Off</label><p class="help-text" style="margin-bottom: 8px;">Select days when no tasks should be scheduled (weekends, rest days, etc.)</p><div style="display: flex; flex-wrap: wrap; gap: 8px;"><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay0" checked><span>Sunday</span></label><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay1"><span>Monday</span></label><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay2"><span>Tuesday</span></label><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay3"><span>Wednesday</span></label><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay4"><span>Thursday</span></label><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay5"><span>Friday</span></label><label class="checkbox-group" style="min-width: 100px;"><input type="checkbox" id="skipDay6" checked><span>Saturday</span></label></div></div></div><div class="actions"><button class="btn" onclick="saveSettings()">Save Settings</button><button class="btn" onclick="resetToDefaults()">Reset to Defaults</button></div></div><div id="tab-merge" class="tab-content"><details class="how-it-works"><summary style="color: #888;">Show Help</summary><div class="intro-content"><p><strong>How Merging Works</strong></p><p>When AutoPlan splits a task into multiple blocks, you can merge them back together here.</p><ul><li><strong>Incomplete splits</strong> are combined into one task</li><li><strong>Time estimates</strong> from all splits are summed together</li><li><strong>The original title</strong> is restored (Roman numerals removed)</li><li><strong>Completed splits</strong> are deleted (their work is already done)</li></ul><p>Use this when you want to reschedule a task differently, or if you finished the work faster than expected.</p></div></details><div class="section"><div class="section-title">Split Task Groups</div><p class="section-description">When AutoPlan splits a task into multiple blocks, you can merge them back together here.</p><button class="btn" onclick="loadSplitGroups()">üîÑ Refresh Split Groups</button><div id="splitGroups" style="margin-top: 16px;"><p style="opacity: 0.7;">Click "Refresh Split Groups" to load split task groups.</p></div></div></div><script>let currentConfig={},availableTags=[],availableProjects=[];async function handleDryRun(){try{if(await saveSettings(),window.parent&&window.parent.AutoPlanAPI){const e=await window.parent.AutoPlanAPI.runAutoplan(!0),t=e.schedule||[],n=e.deadlineMisses||[];if(n.length>0){const e=new Date;showStatus(`‚ö†Ô∏è ${n.map(t=>{const n=t.dueDate<e,a=t.dueDate.toLocaleDateString();return n?`"${t.taskTitle}" is overdue (was ${a})`:`"${t.taskTitle}" will miss deadline (${a})`}).join("; ")}`,"warning",!0)}else showStatus(`Dry Run: ${t.length} blocks would be scheduled`,"success");displaySchedulePreview(t)}else showStatus("AutoPlanAPI not available. Use the header button or Ctrl+Shift+A to run.","info")}catch(e){console.error("Dry run failed:",e),showStatus("Dry run failed: "+e.message,"error")}}async function handleApplySchedule(){const e=document.getElementById("applyButton"),t=document.getElementById("applyButtonContent"),n=t.innerHTML;e.disabled=!0,t.innerHTML='<span class="btn-spinner"></span> Running...';try{if(await saveSettings(),window.parent&&window.parent.AutoPlanAPI){const e=await window.parent.AutoPlanAPI.runAutoplan(!1),t=e.schedule||[],n=e.deadlineMisses||[];if(n.length>0){const e=new Date;showStatus(`‚ö†Ô∏è ${n.map(t=>{const n=t.dueDate<e,a=t.dueDate.toLocaleDateString();return n?`"${t.taskTitle}" is overdue (was ${a})`:`"${t.taskTitle}" will miss deadline (${a})`}).join("; ")}`,"warning",!0)}else showStatus(`AutoPlan complete: ${t.length} blocks scheduled`,"success");await loadTaskPriorities()}else showStatus("AutoPlanAPI not available. Use the header button or Ctrl+Shift+A to run.","info")}catch(e){console.error("AutoPlan failed:",e),showStatus("AutoPlan failed: "+e.message,"error")}finally{e.disabled=!1,t.innerHTML=n}}async function handleRunAutoplan(){return handleApplySchedule()}document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{console.log("[AutoPlan] Tab clicked:",e.dataset.tab),document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active"),e.style.display="none"}),e.classList.add("active");const t=document.getElementById(`tab-${e.dataset.tab}`);console.log("[AutoPlan] Tab content element:",t,"classList before:",t?.classList.toString()),t?(t.classList.add("active"),t.style.display="block",console.log("[AutoPlan] Tab content classList after:",t.classList.toString())):console.error("[AutoPlan] Tab content not found for:",`tab-${e.dataset.tab}`),"merge"===e.dataset.tab?loadSplitGroups():"priorities"===e.dataset.tab?loadTaskPriorities():"time-maps"===e.dataset.tab&&(renderTimeMaps(),renderProjectTimeMapAssignments(),renderTagTimeMapAssignments())})});let statusTimeout=null;function showStatus(e,t="info",n=!1){const a=document.getElementById("status");statusTimeout&&(clearTimeout(statusTimeout),statusTimeout=null),n?a.innerHTML=`<span>${e}</span><button class="status-close" onclick="document.getElementById('status').classList.remove('show')">&times;</button>`:a.textContent=e,a.className=`status show ${t}`,n||(statusTimeout=setTimeout(()=>{a.classList.remove("show"),statusTimeout=null},3e3))}async function loadSettings(){try{const e=await PluginAPI.loadSyncedData();currentConfig=e?JSON.parse(e):getDefaultConfig(),await populateTagDropdown(),await populateProjectDropdown(),applySettingsToUI(),await loadTaskPriorities()}catch(e){console.error("Failed to load settings:",e),currentConfig=getDefaultConfig(),applySettingsToUI();try{await loadTaskPriorities()}catch(e){console.error("Failed to load priorities:",e)}}}async function populateTagDropdown(){try{availableTags=await PluginAPI.getAllTags();const e=document.getElementById("doNotRescheduleTag");for(;e.options.length>1;)e.remove(1);for(const t of availableTags){const n=document.createElement("option");n.value=t.id,n.textContent=t.title,e.appendChild(n)}currentConfig.doNotRescheduleTagId&&(e.value=currentConfig.doNotRescheduleTagId),updateTagPriorityDropdown()}catch(e){console.error("Failed to load tags:",e)}}function updateTagPriorityDropdown(){const e=document.getElementById("newTagName"),t=Object.keys(currentConfig.tagPriorities||{});e.innerHTML='<option value="">Select a tag...</option>';for(const n of availableTags)if(!t.includes(n.title)){const t=document.createElement("option");t.value=n.title,t.textContent=n.title,e.appendChild(t)}}async function populateProjectDropdown(){try{availableProjects=await PluginAPI.getAllProjects(),updateProjectPriorityDropdown()}catch(e){console.error("Failed to load projects:",e)}}function updateProjectPriorityDropdown(){const e=document.getElementById("newProjectName"),t=Object.keys(currentConfig.projectPriorities||{});e.innerHTML='<option value="">Select a project...</option>';for(const n of availableProjects)if(!t.includes(n.title)){const t=document.createElement("option");t.value=n.title,t.textContent=n.title,e.appendChild(t)}}function getDefaultConfig(){return{blockSizeMinutes:120,minimumBlockSizeMinutes:30,tagPriorities:{},projectPriorities:{},durationFormula:"linear",durationWeight:1,oldnessFormula:"linear",oldnessWeight:1,deadlineFormula:"linear",deadlineWeight:12,maxDaysAhead:30,autoRunOnStart:!1,splitSuffix:!0,workdayStartHour:9,workdayHours:8,skipDays:[0,6],doNotRescheduleTagId:null,treatIcalAsFixed:!0,excludeBacklogTasks:!1,timeMaps:{default:{name:"Default",days:{0:null,1:{startHour:9,endHour:17},2:{startHour:9,endHour:17},3:{startHour:9,endHour:17},4:{startHour:9,endHour:17},5:{startHour:9,endHour:17},6:null}}},projectTimeMaps:{},tagTimeMaps:{},defaultTimeMap:"default"}}function applySettingsToUI(){document.getElementById("blockSize").value=currentConfig.blockSizeMinutes||120,document.getElementById("minBlockSize").value=currentConfig.minimumBlockSizeMinutes||30,document.getElementById("maxDays").value=currentConfig.maxDaysAhead||30,document.getElementById("autoRun").checked=currentConfig.autoRunOnStart||!1,document.getElementById("splitSuffix").checked=!1!==currentConfig.splitSuffix,document.getElementById("durationFormula").value=currentConfig.durationFormula||"linear",document.getElementById("durationWeight").value=currentConfig.durationWeight||1,document.getElementById("oldnessFormula").value=currentConfig.oldnessFormula||"linear",document.getElementById("oldnessWeight").value=currentConfig.oldnessWeight||1,document.getElementById("deadlineFormula").value=currentConfig.deadlineFormula||"linear",document.getElementById("deadlineWeight").value=currentConfig.deadlineWeight??12,document.getElementById("workdayStartHour").value=currentConfig.workdayStartHour??9,document.getElementById("workdayHours").value=currentConfig.workdayHours??8;const e=currentConfig.skipDays||[0,6];for(let t=0;t<=6;t++)document.getElementById(`skipDay${t}`).checked=e.includes(t);const t=document.getElementById("doNotRescheduleTag");t&&currentConfig.doNotRescheduleTagId&&(t.value=currentConfig.doNotRescheduleTagId),document.getElementById("treatIcalAsFixed").checked=!1!==currentConfig.treatIcalAsFixed,document.getElementById("excludeBacklogTasks").checked=currentConfig.excludeBacklogTasks||!1,updateTagTable(),updateProjectTable(),updateFormulaPreview(),renderTimeMaps(),renderProjectTimeMapAssignments(),renderTagTimeMapAssignments()}function collectSettingsFromUI(){const e=[];for(let t=0;t<=6;t++)document.getElementById(`skipDay${t}`).checked&&e.push(t);const t=document.getElementById("doNotRescheduleTag").value||null,n=document.getElementById("treatIcalAsFixed").checked,a=document.getElementById("excludeBacklogTasks").checked;return{blockSizeMinutes:parseInt(document.getElementById("blockSize").value)||120,minimumBlockSizeMinutes:parseInt(document.getElementById("minBlockSize").value)||30,maxDaysAhead:parseInt(document.getElementById("maxDays").value)||30,autoRunOnStart:document.getElementById("autoRun").checked,splitSuffix:document.getElementById("splitSuffix").checked,durationFormula:document.getElementById("durationFormula").value,durationWeight:parseFloat(document.getElementById("durationWeight").value)||1,oldnessFormula:document.getElementById("oldnessFormula").value,oldnessWeight:parseFloat(document.getElementById("oldnessWeight").value)||1,deadlineFormula:document.getElementById("deadlineFormula").value,deadlineWeight:parseFloat(document.getElementById("deadlineWeight").value)??12,workdayStartHour:parseInt(document.getElementById("workdayStartHour").value)||9,workdayHours:parseInt(document.getElementById("workdayHours").value)||8,skipDays:e,tagPriorities:currentConfig.tagPriorities||{},projectPriorities:currentConfig.projectPriorities||{},doNotRescheduleTagId:t,treatIcalAsFixed:n,excludeBacklogTasks:a,timeMaps:currentConfig.timeMaps||getDefaultConfig().timeMaps,projectTimeMaps:currentConfig.projectTimeMaps||{},tagTimeMaps:currentConfig.tagTimeMaps||{},defaultTimeMap:currentConfig.defaultTimeMap||"default"}}async function saveSettings(){try{currentConfig=collectSettingsFromUI(),await PluginAPI.persistDataSynced(JSON.stringify(currentConfig)),showStatus("Settings saved successfully!","success")}catch(e){console.error("Failed to save settings:",e),showStatus("Failed to save settings: "+e.message,"error")}}function resetToDefaults(){confirm("Reset all settings to defaults?")&&(currentConfig=getDefaultConfig(),applySettingsToUI(),showStatus("Settings reset to defaults","info"))}function updateTagTable(){const e=document.getElementById("tagTableBody");e.innerHTML="";const t=currentConfig.tagPriorities||{};for(const[n,a]of Object.entries(t)){const t=document.createElement("tr");t.innerHTML=`\n          <td><span class="tag-badge">${escapeHtml(n)}</span></td>\n          <td>\n            <input type="number" value="${a}" \n                   onchange="updateTagPriority('${escapeHtml(n)}', this.value)">\n          </td>\n          <td>\n            <button class="btn btn-small" onclick="removeTagPriority('${escapeHtml(n)}')">\n              Remove\n            </button>\n          </td>\n        `,e.appendChild(t)}0===Object.keys(t).length&&(e.innerHTML='<tr><td colspan="3" style="opacity: 0.7; text-align: center;">No tag priorities configured</td></tr>')}function addTagPriority(){const e=document.getElementById("newTagName"),t=document.getElementById("newTagPriority"),n=e.value,a=parseFloat(t.value)||0;n?(currentConfig.tagPriorities||(currentConfig.tagPriorities={}),currentConfig.tagPriorities[n]=a,updateTagTable(),updateTagPriorityDropdown(),t.value="10"):showStatus("Please select a tag","error")}function updateTagPriority(e,t){currentConfig.tagPriorities[e]=parseFloat(t)||0}function removeTagPriority(e){delete currentConfig.tagPriorities[e],updateTagTable(),updateTagPriorityDropdown()}function updateProjectTable(){const e=document.getElementById("projectTableBody");e.innerHTML="";const t=currentConfig.projectPriorities||{};for(const[n,a]of Object.entries(t)){const t=document.createElement("tr");t.innerHTML=`\n          <td><span class="tag-badge">${escapeHtml(n)}</span></td>\n          <td>\n            <input type="number" value="${a}" \n                   onchange="updateProjectPriority('${escapeHtml(n)}', this.value)">\n          </td>\n          <td>\n            <button class="btn btn-small" onclick="removeProjectPriority('${escapeHtml(n)}')">\n              Remove\n            </button>\n          </td>\n        `,e.appendChild(t)}0===Object.keys(t).length&&(e.innerHTML='<tr><td colspan="3" style="opacity: 0.7; text-align: center;">No project priorities configured</td></tr>')}function addProjectPriority(){const e=document.getElementById("newProjectName"),t=document.getElementById("newProjectPriority"),n=e.value,a=parseFloat(t.value)||0;n?(currentConfig.projectPriorities||(currentConfig.projectPriorities={}),currentConfig.projectPriorities[n]=a,updateProjectTable(),updateProjectPriorityDropdown(),t.value="10"):showStatus("Please select a project","error")}function updateProjectPriority(e,t){currentConfig.projectPriorities[e]=parseFloat(t)||0}function removeProjectPriority(e){delete currentConfig.projectPriorities[e],updateProjectTable(),updateProjectPriorityDropdown()}function updateFormulaPreview(){const e=document.getElementById("durationFormula").value,t=document.getElementById("durationWeight").value,n=document.getElementById("oldnessFormula").value,a=document.getElementById("oldnessWeight").value,i=document.getElementById("deadlineFormula").value,o=document.getElementById("deadlineWeight").value;document.getElementById("durationPreview").textContent=`Duration Priority = ${{none:"disabled",linear:"hours",inverse:"1/(hours+1)",log:"log(hours+1)"}[e]} * ${t}`,document.getElementById("oldnessPreview").textContent=`Oldness Priority = ${{none:"disabled",linear:"days",log:"log(days+1)",exponential:"1.1^days"}[n]} * ${a}`,document.getElementById("deadlinePreview").textContent=`Deadline Priority = ${{none:"disabled",linear:"linear(days_until_due)",aggressive:"aggressive(days_until_due)"}[i]} * ${o}`}async function previewSchedule(){const e=document.getElementById("schedulePreview");e.innerHTML='<div class="loading"><div class="spinner"></div>Generating schedule preview...</div>';try{if(await saveSettings(),window.parent&&window.parent.AutoPlanAPI){const t=(await window.parent.AutoPlanAPI.runAutoplan(!0)).schedule||[];if(0===t.length)return void(e.innerHTML='<p style="opacity: 0.7;">No tasks to schedule. Make sure tasks have time estimates.</p>');const n=new Map;for(const e of t){const t=e.startTime.toLocaleDateString();n.has(t)||n.set(t,[]),n.get(t).push(e)}let a="";a+=`<p style="margin-bottom: 12px; font-weight: 500;">${t.length} blocks scheduled across ${n.size} days:</p>`;for(const[e,t]of n){a+=`<div style="margin-top: 12px; margin-bottom: 8px; font-weight: 600; opacity: 0.8;">${e}</div>`;for(const e of t){const t=e.startTime.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),n=e.endTime.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i=e.split.estimatedHours.toFixed(1);a+=`\n                <div class="schedule-item">\n                  <div class="schedule-title">\n                    <span style="opacity: 0.6; font-size: 0.9em;">${t}-${n}</span>\n                    ${escapeHtml(e.split.title)}\n                  </div>\n                  <div class="schedule-urgency">${i}h</div>\n                </div>\n              `}}e.innerHTML=a}else{const t=(await PluginAPI.getTasks()).filter(e=>!e.isDone&&e.timeEstimate&&e.timeEstimate>0);if(0===t.length)return void(e.innerHTML='<p style="opacity: 0.7;">No tasks with time estimates found</p>');e.innerHTML=`\n            <p style="margin-bottom: 12px;">Found ${t.length} tasks with time estimates:</p>\n            ${t.slice(0,10).map(e=>`\n              <div class="schedule-item">\n                <div class="schedule-title">${escapeHtml(e.title)}</div>\n                <div class="schedule-urgency">${Math.round((e.timeEstimate||0)/36e5)}h</div>\n              </div>\n            `).join("")}\n            ${t.length>10?`<p style="opacity: 0.7;">...and ${t.length-10} more tasks</p>`:""}\n            <p style="margin-top: 12px; opacity: 0.7; font-size: 0.9em;">Note: Full preview requires plugin.js to be loaded.</p>\n          `}}catch(t){console.error("Preview failed:",t),e.innerHTML=`<p style="font-weight: bold;">Error: ${t.message}</p>`}}async function runAutoplan(){try{if(await saveSettings(),window.parent&&window.parent.AutoPlanAPI){const e=await window.parent.AutoPlanAPI.runAutoplan(!1),t=e.deadlineMisses||[];if(t.length>0){const e=new Date;showStatus(`‚ö†Ô∏è ${t.map(t=>{const n=t.dueDate<e,a=t.dueDate.toLocaleDateString();return n?`"${t.taskTitle}" is overdue (was ${a})`:`"${t.taskTitle}" will miss deadline (${a})`}).join("; ")}`,"warning",!0)}else showStatus(`AutoPlan complete: ${e.schedule?.length||0} blocks scheduled`,"success")}else showStatus("Please use the AutoPlan header button or Ctrl+Shift+A to run the scheduler","info")}catch(e){console.error("AutoPlan failed:",e),showStatus("AutoPlan failed: "+e.message,"error")}}function showClearPlanningModal(){document.getElementById("clearPlanningModal").classList.add("show")}function hideClearPlanningModal(e){e&&e.target!==e.currentTarget||document.getElementById("clearPlanningModal").classList.remove("show")}async function confirmClearPlanning(){hideClearPlanningModal();try{if(window.parent&&window.parent.AutoPlanAPI){const e=await window.parent.AutoPlanAPI.clearPlanning();let t="";t=e.merged>0&&e.cleared>0?`Merged ${e.merged} split groups, cleared planning from ${e.cleared} tasks`:e.merged>0?`Merged ${e.merged} split groups`:e.cleared>0?`Cleared planning from ${e.cleared} tasks`:"No tasks to clear",showStatus(t,"success"),await loadTaskPriorities()}else showStatus("AutoPlanAPI not available. Make sure the plugin is properly loaded.","error")}catch(e){console.error("Clear planning failed:",e),showStatus("Clear planning failed: "+e.message,"error")}}async function loadSplitGroups(){console.log("[AutoPlan] loadSplitGroups called");const e=document.getElementById("splitGroups");if(e){e.innerHTML='<div class="loading"><div class="spinner"></div>Loading split groups...</div>';try{if("undefined"==typeof PluginAPI)return void(e.innerHTML='<p style="color: #ff6b6b;">PluginAPI not available. Make sure the plugin is properly loaded.</p>');const t=await PluginAPI.getTasks();console.log("[AutoPlan] loadSplitGroups: Found",t.length,"tasks");const n=findSplitGroups(t);if(console.log("[AutoPlan] loadSplitGroups: Found",n.length,"split groups"),0===n.length)return void(e.innerHTML='<p style="opacity: 0.7;">No split task groups found. Split tasks are created when AutoPlan breaks a large task into smaller time blocks.</p>');const a=new Map;for(const e of t)a.set(e.id,e);const i=n.map(e=>{const t=e.splits.filter(e=>!e.task.isDone),n=e.splits.filter(e=>e.task.isDone),i=t.reduce((e,t)=>e+(t.task.timeEstimate||0),0),o=function(e){const t=e.splits[0]?.task;if(t&&t.parentId){const n=a.get(t.parentId);if(n)return`${n.title} > ${e.originalTitle}`}return e.originalTitle}(e);return`\n            <div class="section" style="margin-bottom: 12px;">\n              <div class="section-title">${escapeHtml(o)}</div>\n              <div style="display: flex; gap: 16px; margin-bottom: 12px;">\n                <span style="opacity: 0.7;">\n                  ${t.length} incomplete / ${n.length} completed\n                </span>\n                <span style="font-weight: 500;">\n                  ${Math.round(i/36e5)}h remaining\n                </span>\n              </div>\n              <div style="margin-bottom: 12px;">\n                ${e.splits.map(e=>`\n                  <div class="schedule-item" style="opacity: ${e.task.isDone?"0.5":"1"};">\n                    <div class="schedule-title">\n                      ${e.task.isDone?"&#x2713; ":""}${escapeHtml(function(e){let t=e.title;if(e.parentId){const n=a.get(e.parentId);n&&(t=`${n.title} > ${e.title}`)}return t}(e.task))}\n                    </div>\n                    <div class="schedule-urgency">\n                      ${Math.round((e.task.timeEstimate||0)/36e5)}h\n                    </div>\n                  </div>\n                `).join("")}\n              </div>\n              ${t.length>1?`\n                <button class="btn btn-small" onclick="mergeSplitGroup('${e.splits[0].task.id}')">\n                  Merge ${t.length} Incomplete Splits\n                </button>\n              `:`\n                <span style="opacity: 0.7; font-size: 0.85em;">\n                  ${1===t.length?"Only 1 incomplete split remaining":"All splits completed"}\n                </span>\n              `}\n            </div>\n          `}).join("");console.log("[AutoPlan] Generated HTML length:",i.length),e.innerHTML=i,console.log("[AutoPlan] Container innerHTML set, children:",e.children.length)}catch(t){console.error("Failed to load split groups:",t),e.innerHTML=`<p style="font-weight: bold;">Error: ${t.message}</p>`}}else console.error("[AutoPlan] splitGroups container not found")}function findSplitGroups(e){const t=new Map;for(const n of e){const e=parseSplitInfo(n);e&&(t.has(e.originalTaskId)||t.set(e.originalTaskId,{originalTaskId:e.originalTaskId,originalTitle:e.originalTitle,splits:[]}),t.get(e.originalTaskId).splits.push({task:n,splitInfo:e}))}for(const e of t.values())e.splits.sort((e,t)=>e.splitInfo.splitIndex-t.splitInfo.splitIndex);return Array.from(t.values())}function parseSplitInfo(e){if(!e.notes)return null;const t=e.notes.match(/\[AutoPlan\] Split (\d+)\/(\d+) of "((?:[^"\\]|\\.)*)"/),n=e.notes.match(/\[AutoPlan\] Original Task ID: ([^\n\s]+)/);return t&&n?{splitIndex:parseInt(t[1])-1,totalSplits:parseInt(t[2]),originalTitle:t[3].replace(/\\"/g,'"'),originalTaskId:n[1].trim()}:null}async function mergeSplitGroup(e){if(confirm("Merge all incomplete splits of this task into one?"))try{if(window.parent&&window.parent.AutoPlanAPI){const t=await window.parent.AutoPlanAPI.mergeSplits(e);t&&(showStatus(`Merged ${t.mergedCount} splits successfully`,"success"),loadSplitGroups())}else{const t=await PluginAPI.getTasks(),n=t.find(t=>t.id===e);if(!n)return void showStatus("Task not found","error");const a=parseSplitInfo(n);if(!a)return void showStatus("Not a split task","error");const i=t.filter(e=>{const t=parseSplitInfo(e);return t&&t.originalTaskId===a.originalTaskId&&!e.isDone});if(i.length<=1)return void showStatus("Nothing to merge","info");let o=0,s=0;for(const e of i)o+=e.timeEstimate||0,s+=e.timeSpent||0;i.sort((e,t)=>{const n=parseSplitInfo(e),a=parseSplitInfo(t);return(n?.splitIndex||0)-(a?.splitIndex||0)});const r=i[0],l=i.slice(1);await PluginAPI.updateTask(r.id,{title:a.originalTitle,timeEstimate:o,timeSpent:s,notes:`[AutoPlan] Merged from ${i.length} split tasks.`});for(const e of l)try{await PluginAPI.deleteTask(e.id)}catch(t){console.warn("Could not delete task:",t),await PluginAPI.updateTask(e.id,{isDone:!0,notes:`${e.notes||""}\n\n[AutoPlan] Merged into task: ${r.id}`})}showStatus(`Merged ${i.length} splits`,"success"),loadSplitGroups()}}catch(e){console.error("Merge failed:",e),showStatus("Merge failed: "+e.message,"error")}}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function loadTaskPriorities(){const e=document.getElementById("prioritiesList");e.innerHTML='<div class="loading"><div class="spinner"></div>Loading task priorities...</div>';try{const t=await PluginAPI.loadSyncedData(),n=t?JSON.parse(t):getDefaultConfig(),a=await PluginAPI.getTasks(),i=await PluginAPI.getAllTags(),o=await PluginAPI.getAllProjects(),s=new Set;for(const e of a)e.parentId&&s.add(e.parentId);const r=new Map;for(const e of a)r.set(e.id,e);const l=new Map,d=[],c=!1!==n.treatIcalAsFixed;for(const e of a){if(e.isDone)continue;if(!e.timeEstimate||e.timeEstimate<=0)continue;if(s.has(e.id))continue;if(c&&"ICAL"===e.issueType)continue;const t=parseSplitInfo(e);t?(l.has(t.originalTaskId)||l.set(t.originalTaskId,{originalTaskId:t.originalTaskId,originalTitle:t.originalTitle,splits:[],representativeTask:e}),l.get(t.originalTaskId).splits.push(e)):d.push(e)}const u=[];for(const e of d)u.push({task:e,displayTitle:e.title,totalEstimate:e.timeEstimate||0,isSplitGroup:!1});for(const e of l.values()){const t=e.splits.reduce((e,t)=>e+(t.timeEstimate||0),0);u.push({task:e.representativeTask,displayTitle:e.originalTitle,totalEstimate:t,isSplitGroup:!0,splitCount:e.splits.length})}if(0===u.length)return void(e.innerHTML='<p style="opacity: 0.7;">No eligible tasks found. Tasks must have time estimates to be scheduled.</p>');const m=new Date,p=u.map(e=>{const t=calculateTaskUrgency({...e.task,timeEstimate:e.totalEstimate},n,i,o,a,m);return{...e,urgency:t.total,components:t.components}});p.sort((e,t)=>t.urgency-e.urgency);let g=`<p style="margin-bottom: 12px; font-weight: 500;">${p.length} tasks sorted by priority:</p>`;for(const e of p){const{task:t,displayTitle:n,totalEstimate:a,urgency:i,components:o,isSplitGroup:s,splitCount:l}=e,d=Math.round(a/36e5*10)/10;let c=n;if(t.parentId){const e=r.get(t.parentId);e&&(c=`${e.title} > ${n}`)}const u=[];0!==o.tag&&u.push(`tag: ${formatNumber(o.tag)}`),0!==o.project&&u.push(`project: ${formatNumber(o.project)}`),0!==o.duration&&u.push(`duration: ${formatNumber(o.duration)}`),0!==o.oldness&&u.push(`oldness: ${formatNumber(o.oldness)}`),0!==o.deadline&&u.push(`deadline: ${formatNumber(o.deadline)}`);const m=u.length>0?u.join(" + "):"no priority factors applied",p=s?` (${l} splits)`:"";g+=`\n            <div class="priority-item">\n              <div class="priority-header">\n                <div class="priority-title">${escapeHtml(c)}${p}</div>\n                <div class="priority-score">${formatNumber(i)}</div>\n              </div>\n              <div class="priority-explanation">${d}h est. | ${m}</div>\n            </div>\n          `}e.innerHTML=g}catch(t){console.error("Failed to load priorities:",t),e.innerHTML=`<p style="font-weight: bold;">Error: ${t.message}</p>`}}function formatNumber(e){if(0===e)return"0";const t=Math.round(10*e)/10;return t%1==0?t.toString():t.toFixed(1)}function displaySchedulePreview(e){const t=document.getElementById("schedulePreviewSection"),n=document.getElementById("schedulePreview");if(!e||0===e.length)return void(t.style.display="none");t.style.display="block";const a=new Map;let i=0;const o=new Set;for(const t of e){const e=t.startTime.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});a.has(e)||a.set(e,[]),a.get(e).push(t);i+=(t.endTime-t.startTime)/6e4,o.add(t.split.originalTaskId)}const s=Math.round(i/6)/10,r=a.size,l=e[0].startTime.toLocaleDateString(),d=e[e.length-1].startTime.toLocaleDateString();let c=`\n        <div class="schedule-summary">\n          <div class="schedule-summary-row">\n            <span>Total blocks:</span>\n            <strong>${e.length}</strong>\n          </div>\n          <div class="schedule-summary-row">\n            <span>Total time:</span>\n            <strong>${s} hours</strong>\n          </div>\n          <div class="schedule-summary-row">\n            <span>Unique tasks:</span>\n            <strong>${o.size}</strong>\n          </div>\n          <div class="schedule-summary-row">\n            <span>Date range:</span>\n            <strong>${l} - ${d} (${r} days)</strong>\n          </div>\n        </div>\n        <div class="schedule-preview">\n      `;for(const[e,t]of a){c+=`\n          <div class="schedule-day">\n            <div class="schedule-day-header">${e}</div>\n        `;for(const e of t){const t=e.startTime.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),n=e.endTime.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),a=e.split.originalTitle||e.split.title||"Untitled",i=e.split.splitIndex>0?` [${e.split.splitIndex+1}/${e.split.totalSplits||"?"}]`:"";c+=`\n            <div class="schedule-item">\n              <span class="schedule-time">${t} - ${n}</span>\n              <span class="schedule-title">${escapeHtml(a)}${i}</span>\n              <span class="schedule-urgency" title="Priority score">${formatNumber(e.urgency)}</span>\n            </div>\n          `}c+="</div>"}c+="</div>",n.innerHTML=c,t.scrollIntoView({behavior:"smooth",block:"start"})}function calculateTaskUrgency(e,t,n,a,i,o){const s=calculateTagPriority(e,t.tagPriorities||{},n,i),r=calculateProjectPriority(e,t.projectPriorities||{},a),l=calculateDurationPriority(e,t.durationFormula||"none",t.durationWeight??1),d=calculateOldnessPriority(e,t.oldnessFormula||"none",t.oldnessWeight??1,o),c=calculateDeadlinePriority(e,t.deadlineFormula||"linear",t.deadlineWeight??12,o),u=t.urgencyWeight??1;return{total:(s+r+l+d)*u+c,components:{tag:s*u,project:r*u,duration:l*u,oldness:d*u,deadline:c}}}function getEffectiveTagIds(e,t){const n=new Set(e.tagIds||[]);if(e.parentId&&t){const a=t.find(t=>t.id===e.parentId);if(a){const e=getEffectiveTagIds(a,t);for(const t of e)n.add(t)}}return Array.from(n)}function calculateTagPriority(e,t,n,a){const i=getEffectiveTagIds(e,a);if(0===i.length)return 0;if(!t||"object"!=typeof t)return 0;let o=0;for(const e of i){const a=n.find(t=>t.id===e);a&&void 0!==t[a.title]&&(o+=Number(t[a.title])||0)}return o}function calculateProjectPriority(e,t,n){if(!e.projectId)return 0;if(!t||"object"!=typeof t)return 0;const a=n.find(t=>t.id===e.projectId);return a&&void 0!==t[a.title]&&Number(t[a.title])||0}function getRemainingHours(e){const t=(e.timeEstimate||0)/36e5,n=(e.timeSpent||0)/36e5;return Math.max(0,t-n)}function calculateDurationPriority(e,t,n){const a=getRemainingHours(e);if(a<=0||"none"===t)return 0;if(n<=0)return 0;let i;switch(t){case"inverse":i=1/(a+1);break;case"log":i=Math.log(a+1);break;default:i=a}return i*n}function getTaskAgeInDays(e,t){if(!e.created)return 0;const n=new Date(e.created);return Math.abs(t-n)/864e5}function calculateOldnessPriority(e,t,n,a){const i=getTaskAgeInDays(e,a);if(i<=0||"none"===t)return 0;if(n<=0)return 0;let o;switch(t){case"exponential":const e=Math.min(i,100);o=Math.pow(1.1,e);break;case"log":o=Math.log(i+1);break;default:o=i}return o*n}function parseDeadlineFromNotes(e){if(!e||"string"!=typeof e)return null;const t=[/(?:deadline)\s*:\s*(\d{4}-\d{2}-\d{2})/i,/(?:deadline)\s*:\s*([A-Za-z]{3,9}\s+\d{1,2},?\s+\d{4})/i,/(?:deadline)\s*:\s*(\d{1,2}\/\d{1,2}\/\d{4})/i];for(const n of t){const t=e.match(n);if(t){const e=t[1];if(e.includes("/")){const t=e.split("/");if(3===t.length){const[e,n,a]=t.map(e=>parseInt(e,10));if(e>12&&n>=1&&n<=12)return new Date(a,n-1,e);if(e>=1&&e<=12&&n>=1&&n<=31)return new Date(a,e-1,n)}}else{const t=new Date(e);if(!isNaN(t.getTime()))return t}}}return null}function getTaskDueDate(e){const t=parseDeadlineFromNotes(e.notes);return t||(e.dueDate?new Date(e.dueDate):null)}function calculateDeadlinePriority(e,t,n,a){if("none"===t)return 0;if(n<=0)return 0;const i=getTaskDueDate(e);if(!i)return 0;const o=(i-a)/864e5;let s;if("aggressive"===t)s=o<=-7?1:o<=0?.9+-o/7*.1:o<=7?.9-o/7*.4:o<=14?.5-(o-7)/7*.3:.2;else s=o<=-7?1:o>=14?.2:1-(o+7)/21*.8;return s*n}["durationFormula","durationWeight","oldnessFormula","oldnessWeight","deadlineFormula","deadlineWeight"].forEach(e=>{document.getElementById(e).addEventListener("change",updateFormulaPreview)});const DAY_NAMES=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],DAY_ABBREV=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];let editingTimeMapId=null;function getDefaultTimeMap(){return{name:"New Time Map",days:{0:null,1:{startHour:9,endHour:17},2:{startHour:9,endHour:17},3:{startHour:9,endHour:17},4:{startHour:9,endHour:17},5:{startHour:9,endHour:17},6:null}}}function generateTimeMapId(e){const t=e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,""),n=Object.keys(currentConfig.timeMaps||{});let a=t||"time-map",i=1;for(;n.includes(a);)a=`${t}-${i}`,i++;return a}function ensureTimeMapsConfig(){currentConfig.timeMaps||(currentConfig.timeMaps={default:createTimeMapFromLegacy(currentConfig)}),currentConfig.projectTimeMaps||(currentConfig.projectTimeMaps={}),currentConfig.defaultTimeMap||(currentConfig.defaultTimeMap="default")}function createTimeMapFromLegacy(e){const t=e.workdayStartHour??9,n=t+(e.workdayHours??8),a=e.skipDays??[0,6],i={};for(let e=0;e<7;e++)a.includes(e)?i[e]=null:i[e]={startHour:t,endHour:n};return{name:"Default",days:i}}function formatHours(e){if(!e)return"Off";return`${e.startHour}:00-${e.endHour}:00`}function renderTimeMaps(){ensureTimeMapsConfig();const e=document.getElementById("timeMapsContainer");if(!e)return;const t=currentConfig.timeMaps||{};if(0===Object.keys(t).length)return void(e.innerHTML='<p style="opacity: 0.7;">No time maps configured. Click "Add Time Map" to create one.</p>');let n="";for(const[e,a]of Object.entries(t)){const t=e===currentConfig.defaultTimeMap;n+=`\n          <div class="time-map-card">\n            <div class="time-map-header">\n              <span class="time-map-name">${escapeHtml(a.name)}${t?" (default)":""}</span>\n              <div class="time-map-actions">\n                <button class="btn btn-small" onclick="editTimeMap('${escapeHtml(e)}')">Edit</button>\n                ${"default"!==e?`<button class="btn btn-small btn-danger" onclick="deleteTimeMap('${escapeHtml(e)}')">Delete</button>`:""}\n              </div>\n            </div>\n            <div class="time-map-schedule">\n              ${[0,1,2,3,4,5,6].map(e=>{const t=a.days[e],n=!t;return`\n                  <div class="time-map-day${n?" skip":""}">\n                    <div class="time-map-day-name">${DAY_ABBREV[e]}</div>\n                    <div class="time-map-day-hours">${n?"Off":formatHours(t)}</div>\n                  </div>\n                `}).join("")}\n            </div>\n          </div>\n        `}e.innerHTML=n,updateTimeMapDropdowns()}function updateTimeMapDropdowns(){ensureTimeMapsConfig();const e=currentConfig.timeMaps||{},t=document.getElementById("defaultTimeMapSelect");if(t){const n=t.value||currentConfig.defaultTimeMap;t.innerHTML=Object.entries(e).map(([e,t])=>`<option value="${escapeHtml(e)}"${e===n?" selected":""}>${escapeHtml(t.name)}</option>`).join("")}const n=document.getElementById("newProjectTimeMapTimeMap");n&&(n.innerHTML='<option value="">Select a time map...</option>'+Object.entries(e).map(([e,t])=>`<option value="${escapeHtml(e)}">${escapeHtml(t.name)}</option>`).join(""))}function updateProjectTimeMapDropdown(){const e=document.getElementById("newProjectTimeMapProject");if(!e)return;const t=Object.keys(currentConfig.projectTimeMaps||{});e.innerHTML='<option value="">Select a project...</option>';for(const n of availableProjects)if(!t.includes(n.id)){const t=document.createElement("option");t.value=n.id,t.textContent=n.title,e.appendChild(t)}}function renderProjectTimeMapAssignments(){ensureTimeMapsConfig();const e=document.getElementById("projectTimeMapTableBody");if(!e)return;const t=currentConfig.projectTimeMaps||{},n=currentConfig.timeMaps||{};if(0===Object.keys(t).length)return e.innerHTML='<tr><td colspan="3" style="opacity: 0.7; text-align: center;">No project assignments. All projects use the default time map.</td></tr>',void updateProjectTimeMapDropdown();let a="";for(const[e,i]of Object.entries(t)){const t=availableProjects.find(t=>t.id===e),o=n[i];t&&o&&(a+=`\n          <tr>\n            <td><span class="tag-badge">${escapeHtml(t.title)}</span></td>\n            <td>${escapeHtml(o.name)}</td>\n            <td>\n              <button class="btn btn-small" onclick="removeProjectTimeMapAssignment('${escapeHtml(e)}')">\n                Remove\n              </button>\n            </td>\n          </tr>\n        `)}""===a&&(a='<tr><td colspan="3" style="opacity: 0.7; text-align: center;">No project assignments. All projects use the default time map.</td></tr>'),e.innerHTML=a,updateProjectTimeMapDropdown()}function showAddTimeMapModal(){editingTimeMapId=null,document.getElementById("timeMapModalTitle").textContent="Add Time Map",document.getElementById("timeMapName").value="",renderTimeMapDaysEditor(getDefaultTimeMap()),document.getElementById("timeMapModal").classList.add("show")}function editTimeMap(e){ensureTimeMapsConfig();const t=currentConfig.timeMaps[e];t&&(editingTimeMapId=e,document.getElementById("timeMapModalTitle").textContent="Edit Time Map",document.getElementById("timeMapName").value=t.name,renderTimeMapDaysEditor(t),document.getElementById("timeMapModal").classList.add("show"))}function renderTimeMapDaysEditor(e){const t=document.getElementById("timeMapDaysEditor");if(!t)return;let n="";for(let t=0;t<7;t++){const a=e.days[t],i=!a;n+=`\n          <div class="day-editor-row">\n            <span class="day-editor-name">${DAY_NAMES[t]}</span>\n            <div class="day-editor-inputs">\n              <input type="number" id="dayStart${t}" min="0" max="23" value="${a?.startHour??9}" ${i?"disabled":""}>\n              <span>to</span>\n              <input type="number" id="dayEnd${t}" min="1" max="24" value="${a?.endHour??17}" ${i?"disabled":""}>\n              <div class="checkbox-group">\n                <input type="checkbox" id="daySkip${t}" ${i?"checked":""} onchange="toggleDayInputs(${t})">\n                <label for="daySkip${t}">Skip</label>\n              </div>\n            </div>\n          </div>\n        `}t.innerHTML=n}function toggleDayInputs(e){const t=document.getElementById(`daySkip${e}`),n=document.getElementById(`dayStart${e}`),a=document.getElementById(`dayEnd${e}`);t.checked?(n.disabled=!0,a.disabled=!0):(n.disabled=!1,a.disabled=!1)}function hideTimeMapModal(e){e&&e.target!==e.currentTarget||(document.getElementById("timeMapModal").classList.remove("show"),editingTimeMapId=null)}function timeRangesOverlap(e,t,n,a){return e<a&&n<t}function checkTimeMapOverlaps(e,t=null){ensureTimeMapsConfig();const n=[];for(const[a,i]of Object.entries(currentConfig.timeMaps))if(a!==t)for(let t=0;t<7;t++){const o=e[t],s=i.days?.[t];o&&s&&(timeRangesOverlap(o.startHour,o.endHour,s.startHour,s.endHour)&&n.push({day:t,dayName:DAY_NAMES[t],existingMapName:i.name,existingMapId:a,newHours:`${o.startHour}:00-${o.endHour}:00`,existingHours:`${s.startHour}:00-${s.endHour}:00`}))}return n}function saveTimeMap(){const e=document.getElementById("timeMapName").value.trim();if(!e)return void showStatus("Please enter a name for the time map","error");const t={};for(let e=0;e<7;e++){if(document.getElementById(`daySkip${e}`).checked)t[e]=null;else{const n=parseInt(document.getElementById(`dayStart${e}`).value)||9,a=parseInt(document.getElementById(`dayEnd${e}`).value)||17;if(a<=n)return void showStatus(`Invalid hours for ${DAY_NAMES[e]}: end hour must be after start hour`,"error");t[e]={startHour:n,endHour:a}}}const n=checkTimeMapOverlaps(t,editingTimeMapId);if(n.length>0){const e=n.map(e=>`  - ${e.dayName}: ${e.newHours} overlaps with "${e.existingMapName}" (${e.existingHours})`).join("\n");return void alert(`Cannot save time map: overlapping schedules detected!\n\n${e}\n\nTip: If you need a task to be schedulable in multiple time windows, use Tags to assign it to multiple time maps instead of creating overlapping time maps.`)}let a;ensureTimeMapsConfig(),editingTimeMapId?(a=editingTimeMapId,currentConfig.timeMaps[a]={name:e,days:t}):(a=generateTimeMapId(e),currentConfig.timeMaps[a]={name:e,days:t}),hideTimeMapModal(),renderTimeMaps(),renderProjectTimeMapAssignments(),renderTagTimeMapAssignments(),showStatus(`Time map "${e}" saved`,"success")}function deleteTimeMap(e){ensureTimeMapsConfig();const t=currentConfig.timeMaps[e];if(t&&confirm(`Delete time map "${t.name}"? Projects and tags using this time map will fall back to the default.`)){delete currentConfig.timeMaps[e];for(const[t,n]of Object.entries(currentConfig.projectTimeMaps))n===e&&delete currentConfig.projectTimeMaps[t];if(currentConfig.tagTimeMaps)for(const[t,n]of Object.entries(currentConfig.tagTimeMaps))n===e&&delete currentConfig.tagTimeMaps[t];currentConfig.defaultTimeMap===e&&(currentConfig.defaultTimeMap="default"),renderTimeMaps(),renderProjectTimeMapAssignments(),renderTagTimeMapAssignments(),showStatus("Time map deleted","success")}}function updateDefaultTimeMap(){const e=document.getElementById("defaultTimeMapSelect");e&&(currentConfig.defaultTimeMap=e.value)}function addProjectTimeMapAssignment(){const e=document.getElementById("newProjectTimeMapProject"),t=document.getElementById("newProjectTimeMapTimeMap"),n=e.value,a=t.value;if(!n)return void showStatus("Please select a project","error");if(!a)return void showStatus("Please select a time map","error");ensureTimeMapsConfig(),currentConfig.projectTimeMaps[n]=a,renderProjectTimeMapAssignments(),e.value="",t.value="";const i=availableProjects.find(e=>e.id===n),o=currentConfig.timeMaps[a];showStatus(`Assigned "${i?.title}" to "${o?.name}"`,"success")}function removeProjectTimeMapAssignment(e){ensureTimeMapsConfig(),delete currentConfig.projectTimeMaps[e],renderProjectTimeMapAssignments()}function renderTagTimeMapAssignments(){const e=document.getElementById("tagTimeMapTableBody"),t=document.getElementById("newTagTimeMapTag"),n=document.getElementById("newTagTimeMapTimeMap");if(!e)return;ensureTimeMapsConfig();const a=currentConfig.tagTimeMaps||{},i=currentConfig.timeMaps||{},o=Object.keys(a);e.innerHTML="";for(const[t,n]of Object.entries(a)){const a=availableTags.find(e=>e.id===t),o=i[n],s=document.createElement("tr");s.innerHTML=`\n          <td>${a?.title||t}</td>\n          <td>${o?.name||n}</td>\n          <td>\n            <button class="btn btn-small btn-danger" onclick="removeTagTimeMapAssignment('${t}')">Remove</button>\n          </td>\n        `,e.appendChild(s)}if(t){t.innerHTML='<option value="">Select a tag...</option>';for(const e of availableTags)if(!o.includes(e.id)){const n=document.createElement("option");n.value=e.id,n.textContent=e.title,t.appendChild(n)}}if(n){n.innerHTML='<option value="">Select a time map...</option>';for(const[e,t]of Object.entries(i)){const a=document.createElement("option");a.value=e,a.textContent=t.name||e,n.appendChild(a)}}}function addTagTimeMapAssignment(){const e=document.getElementById("newTagTimeMapTag"),t=document.getElementById("newTagTimeMapTimeMap"),n=e.value,a=t.value;if(!n)return void showStatus("Please select a tag","error");if(!a)return void showStatus("Please select a time map","error");ensureTimeMapsConfig(),currentConfig.tagTimeMaps||(currentConfig.tagTimeMaps={}),currentConfig.tagTimeMaps[n]=a,renderTagTimeMapAssignments(),e.value="",t.value="";const i=availableTags.find(e=>e.id===n),o=currentConfig.timeMaps[a];showStatus(`Assigned "${i?.title}" to "${o?.name}"`,"success")}function removeTagTimeMapAssignment(e){ensureTimeMapsConfig(),currentConfig.tagTimeMaps&&delete currentConfig.tagTimeMaps[e],renderTagTimeMapAssignments()}document.addEventListener("DOMContentLoaded",()=>{loadSettings()}),"loading"!==document.readyState&&loadSettings();</script><div id="clearPlanningModal" class="modal-overlay" onclick="hideClearPlanningModal(event)"><div class="modal" onclick="event.stopPropagation()"><div class="modal-title">Clear All Planning?</div><div class="modal-body"><p>This will:</p><ul><li>Merge all split tasks back together</li><li>Remove scheduled times from tasks with time estimates</li></ul><p><strong>Note:</strong> Tasks with "Do Not Reschedule" tag are not affected.</p></div><div class="modal-actions"><button class="btn" onclick="hideClearPlanningModal()">Cancel</button><button class="btn btn-danger" onclick="confirmClearPlanning()">Clear Planning</button></div></div></div><div id="timeMapModal" class="modal-overlay" onclick="hideTimeMapModal(event)"><div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()"><div class="modal-title" id="timeMapModalTitle">Add Time Map</div><div class="modal-body"><div class="form-group"><label for="timeMapName">Time Map Name</label><input type="text" id="timeMapName" placeholder="e.g., Work Hours, Evenings, Weekends"></div><div class="form-group"><label>Schedule per Day</label><p class="help-text" style="margin-bottom: 8px;">Set start and end hours for each day, or check "Skip" to not schedule on that day.</p><div id="timeMapDaysEditor"></div></div></div><div class="modal-actions"><button class="btn" onclick="hideTimeMapModal()">Cancel</button><button class="btn btn-primary" onclick="saveTimeMap()">Save</button></div></div></div></body></html>